#!/usr/bin/env ruby
# -!- mode: ruby -!-

# Wrapper for management functions for manage-courses-backend
#
# Run with:
#
#  bundle exec mcb

require 'ap'
require 'cri'
require 'rainbow'
require 'pry'
require 'table_print'
require 'terminal-table'
require 'tabulo'

lib_dir = File.expand_path 'lib'

$LOAD_PATH << lib_dir
require 'mcb'
require 'mcb/azure'
require 'mcb/config'
require 'mcb/course_show'
require 'mcb/courses_editor'
require 'mcb/courses_editor_cli'
require 'mcb/grant_access_wizard'
require 'mcb/revoke_access_wizard'
require 'mcb/render'
require 'mcb/render/active_record'
require 'mcb/render/apiv1'

tp.set :capitalize_headers, false

$mcb = Cri::Command.define do
  name        'mcb'
  usage       'mcb [options]'
  summary     'wrapper for management of manage-curses-backend app'

  option :v, 'verbose',
         'display additional info (for commands that support it)' do |value|
    MCB::LOGGER.level = Logger::INFO
    $verbosity = :verbose if value
  end

  flag :h, :help, 'show help for this command' do |_value, cmd|
    puts cmd.help
    puts
    puts Rainbow("SUBCOMMANDS").red.bright
    prefix = "    "
    cmd.commands.each do |c|
      show_all_commands(c, prefix + c.name + " ")
      puts
    end
    # Don't exit if we're in repl-mode.
    exit 0 unless $mcb_repl_mode
  end

  option :c, :config, 'use provided config file',
         argument: :required do |config_file|
    MCB.config_file = config_file
  end
end

def show_all_commands(cmd, prefix)
  cmd.commands.each do |c|
    aligned_cmd_name = (prefix + c.name).ljust(37, ' ')
    coloured_name = Rainbow(aligned_cmd_name).green
    puts "#{coloured_name} #{c.summary}"
    show_all_commands(c, prefix + c.name + " ")
  end
end

MCB.load_commands($mcb, "#{lib_dir}/mcb/commands")

def verbose(msg)
  MCB::LOGGER.info msg
end

def error(msg)
  puts msg
end

if File.basename(__FILE__) == File.basename($0)
  if ARGV.empty? || ARGV.first == '-E'
    MCB.start_mcb_repl(ARGV)
  else
    $mcb.run(ARGV.dup)
  end
end
